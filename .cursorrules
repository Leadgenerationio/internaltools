You are building "Ad Maker" — a Next.js web app that generates funnel-based ad copy via AI, lets users review/edit it, then batch-renders video ads with timed text overlays and background music using server-side FFmpeg.

## IMPORTANT: Keep Docs In Sync
After any new feature or major change, always update `ARCHITECTURE.md`, `CLAUDE.md`, and `.cursorrules` to reflect the current state. Don't ask — just do it.

## Architecture

- **Framework**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Database**: PostgreSQL + Prisma ORM (multi-tenant companies, users, API usage tracking)
- **Authentication**: NextAuth v5 (credentials provider, JWT sessions, httpOnly cookies)
- **Multi-tenancy**: Companies with users (roles: OWNER/ADMIN/MEMBER), data filtered by company_id
- **Token billing**: Token-based billing system (`src/lib/token-pricing.ts`, `src/lib/token-balance.ts`). 1 token = 1 finished video, 3-25 tokens per AI video (per-model pricing). Ad copy generation is FREE. Atomic deduction via raw SQL prevents race conditions.
- **Cloud storage**: Optional S3/R2 via `src/lib/storage.ts`. Streaming uploads via `@aws-sdk/lib-storage`. CDN offloading via `CDN_URL` env var in `fileUrl()`.
- **Payments**: Stripe Checkout + Customer Portal for subscriptions and token top-ups (`src/lib/stripe.ts`, `/api/billing/create-checkout`, `/api/billing/manage`, `/api/webhooks/stripe`)
- **Email**: Resend SDK for transactional emails — 11 templates including welcome, reset, upgrade, budget alerts, receipts, team invite, render complete/failed, subscription renewal, ticket created/reply (`src/lib/email.ts`)
- **Internal cost tracking**: Per-call API usage logging in cents (`src/lib/track-usage.ts`, `src/lib/pricing.ts`) — admin-only, hidden from users
- **Video processing**: FFmpeg via shell exec (server-side), @napi-rs/canvas for emoji-supporting overlay PNGs
- **AI ad copy**: Anthropic SDK (Claude Sonnet) for generating TOFU/MOFU/BOFU ad text
- **AI video generation**: kie.ai REST API — 6 models: Seedance 1.5, Kling 2.6, Veo 3.1 Fast, Sora 2, Sora 2 Pro, Veo 3.1 Quality. Two API patterns: Veo `/veo/` and Market `/jobs/`.
- **File handling**: Uploads in `public/uploads/`, music in `public/music/`, outputs in `public/outputs/` (symlinked to Railway Volume via `docker-entrypoint.sh`)
- **File serving**: All file URLs use `/api/files?path=xxx` (Next.js standalone doesn't serve runtime files from `public/`). Use `fileUrl()` from `src/lib/file-url.ts` to generate URLs. Files streamed with Range header support.
- **Cloud storage**: Optional S3/R2 support via `src/lib/storage.ts` (activated by `S3_BUCKET` env var)
- **Redis**: Optional `ioredis` via `src/lib/redis.ts` (from `REDIS_URL`). Used for rate limiting + caching. Graceful fallback when unavailable.
- **Caching**: `src/lib/cache.ts` — Redis-backed TTL cache for company balance (10s) and notification count (15s). Invalidated on writes.
- **Rate limiting**: Dual-layer — in-memory in middleware (Edge), Redis sorted-set in `src/lib/rate-limit.ts` (Node.js API routes)
- **DB Pool**: `pg.Pool` with `max: 20` (configurable via `DB_POOL_SIZE`) in `src/lib/prisma.ts`
- **State**: React useState (no external state management)
- **Logging**: Winston with daily-rotate-file, client-side logs forwarded via `/api/log`
- **Background jobs**: BullMQ + Redis for async render/video-gen. Routes return `{ jobId }`, client polls `/api/jobs/[id]`. Workers run as separate Railway service (`WORKER_MODE=true`). Falls back to sync when no Redis.
- **Redis**: ioredis at `src/lib/redis.ts` — queues, rate limiting, caching. All features degrade gracefully.
- **Deployment**: Railway with Docker, Next.js standalone output, Railway Volume for persistent file storage. Worker service uses same Docker image with `WORKER_MODE=true`.
- **Admin dashboard**: Super admin panel at `/admin` with 5 tabs (Overview, Companies, Users, Transactions, Support). Auth via `src/lib/admin-auth.ts`. Audit logging via `AdminAuditLog` model.
- **Support ticketing**: User pages at `/tickets/*`, admin routes at `/api/admin/tickets/*`. Auto-incrementing numbers, email notifications, `src/lib/sanitize.ts` for input sanitization.
- **Google Drive export**: OAuth2 integration with 6 routes at `/api/integrations/google-drive/*`. `GoogleDriveButton` component in render results. User model stores Drive tokens.
- **In-app notifications**: `NotificationBell` component with 30s polling. API at `/api/notifications/*`. `Notification` model in Prisma.
- **Onboarding**: 5-step `OnboardingChecklist` for accounts <7 days old. API at `/api/onboarding`.
- **Project templates**: 6 system + company-owned templates. `TemplatePickerModal` + `SaveAsTemplateModal` in Brief step. Seed via `scripts/seed-templates.ts`. API at `/api/templates/*`.

## App Flow (4 Steps)

1. **Brief** — User fills in a rich ad brief (product, audience, selling points, ad examples, tone, context)
2. **Review** — AI generates 10 ads (4 TOFU, 4 MOFU, 2 BOFU), each with 4-5 text boxes. User edits text, approves/rejects/regenerates individually.
3. **Media** — Upload background videos (or generate via kie.ai — Seedance, Kling, Veo, Sora), upload music, configure overlay style (presets + custom colours/fonts/timing)
4. **Render** — Each approved ad is rendered against each uploaded video via FFmpeg. Results shown with progress bar and download all.

## Key Concepts

### Text Overlay Rendering
- Overlays are rendered to PNG using @napi-rs/canvas (NOT FFmpeg drawtext) to support emoji
- PNGs are composited onto video using FFmpeg's `overlay` filter with `enable='between(t,start,end)'`
- Overlays stack vertically from top, each appearing at a staggered time (user-configurable)
- Once a box appears, it stays visible until the video ends
- Style is configurable: preset picker (White Box, Dark Box, Gradient, Minimal) + custom colours, font, opacity

### Funnel Ad Generation
- TOFU (Top of Funnel): Awareness — hooks, curiosity gaps, pain points
- MOFU (Middle of Funnel): Consideration — trust, social proof, education
- BOFU (Bottom of Funnel): Conversion — urgency, CTAs, offers
- No branding is added — "Andro Media" refers to Meta's ad system, not a brand

### Batch Processing
- Users upload multiple background videos
- All approved ads are rendered against all uploaded videos
- E.g. 5 approved ads × 2 videos = 10 output videos
- Partial failure handling — if one ad fails, the rest still render

## File Structure
```
src/
  app/
    page.tsx                      — Main 4-step flow controller (requires auth)
    layout.tsx                    — Root layout
    globals.css                   — Tailwind + custom styles
    welcome/
      page.tsx                    — Public landing page (hero, features, pricing)
    login/
      page.tsx                    — NextAuth login page
    register/
      page.tsx                    — Registration page (new company + user)
    projects/
      page.tsx                    — Projects list (grid of cards, create/delete, pagination)
    usage/
      page.tsx                    — Token usage dashboard (balance, by-reason, by-user)
    settings/
      page.tsx                    — Company settings (users, invitations, token budget, password, Google Drive, templates)
    admin/
      page.tsx                    — Super admin dashboard (5 tabs: Overview, Companies, Users, Transactions, Support)
    tickets/
      page.tsx                    — Support ticket list (filterable)
      new/page.tsx                — Create new support ticket
      [id]/page.tsx               — Ticket detail with threaded messages
    suspended/
      page.tsx                    — Suspended company landing page
    billing/
      page.tsx                    — Plan comparison, Stripe Checkout, token top-ups
      layout.tsx                  — Metadata + Suspense boundary
    privacy/
      page.tsx                    — Privacy Policy (GDPR-compliant)
    terms/
      page.tsx                    — Terms of Service
    help/
      page.tsx                    — Help center (~28 FAQ articles, search)
      layout.tsx                  — Metadata
    reset-password/
      page.tsx                    — Forgot password / reset password flow
    error.tsx                      — App-level error boundary
    api/
      auth/[...nextauth]/
        route.ts                  — NextAuth v5 credentials provider
      auth/register/route.ts      — Create new user + company
      auth/reset-password/route.ts — Password reset (request + execute)
      company/users/route.ts      — List, add, remove users
      company/invite/route.ts     — Invite users (+ user limit check)
      company/settings/route.ts   — Company settings: token budget, name (GET/PUT)
      company/logo/route.ts       — Logo upload (POST)
      billing/balance/route.ts    — Token balance, monthly usage, plan info (GET)
      billing/transactions/route.ts — Paginated token transaction history (GET)
      billing/create-checkout/route.ts — Stripe Checkout for subs + top-ups (POST)
      billing/manage/route.ts     — Stripe Customer Portal session (POST)
      webhooks/stripe/route.ts    — Stripe webhook handler (POST)
      usage/route.ts              — Token usage dashboard (balance, by-reason, by-user, transactions)
      usage/export/route.ts       — CSV export of token transactions
      auth/change-password/route.ts — Authenticated password change
      admin/route.ts              — Super admin platform-wide stats + company breakdown
      admin/companies/route.ts    — Admin: list all companies
      admin/companies/[id]/route.ts — Admin: get/update company (plan, suspension)
      admin/companies/[id]/grant-tokens/route.ts — Admin: grant tokens
      admin/users/route.ts        — Admin: list all users
      admin/impersonate/route.ts  — Admin: impersonate user
      admin/transactions/route.ts — Admin: platform-wide transactions
      admin/tickets/route.ts      — Admin: list support tickets
      admin/tickets/[id]/route.ts — Admin: manage ticket
      admin/tickets/stats/route.ts — Admin: ticket statistics
      tickets/route.ts            — User: list/create tickets
      tickets/[id]/route.ts       — User: ticket detail
      tickets/[id]/messages/route.ts — User: send ticket message
      notifications/route.ts      — List notifications
      notifications/[id]/read/route.ts — Mark notification read
      notifications/mark-all-read/route.ts — Mark all read
      notifications/stream/route.ts — SSE real-time notification push
      integrations/google-drive/auth/route.ts — Google Drive OAuth2 start
      integrations/google-drive/callback/route.ts — Google Drive OAuth2 callback
      integrations/google-drive/disconnect/route.ts — Disconnect Google Drive
      integrations/google-drive/status/route.ts — Google Drive connection status
      integrations/google-drive/folders/route.ts — List Drive folders
      integrations/google-drive/export/route.ts — Export video to Drive
      templates/route.ts          — List/create project templates
      templates/[id]/route.ts     — CRUD template
      templates/[id]/use/route.ts — Use template for brief
      onboarding/route.ts         — Get/update onboarding checklist
      health/route.ts             — Health check (DB + FFmpeg)
      projects/route.ts           — List + create projects (GET/POST)
      projects/[id]/route.ts     — Get, update, delete project (GET/PUT/DELETE)
      projects/[id]/ads/route.ts — Save ads to project (POST — replace all)
      generate-ads/route.ts       — Claude API for ad copy (+ cost tracking)
      generate-video/route.ts     — kie.ai video gen API (Veo + Market patterns, + cost tracking)
      upload/route.ts             — Video upload (validates size, extracts metadata)
      upload-music/route.ts       — Music upload (validates format + size)
      render/route.ts             — FFmpeg batch render + cloud storage (+ cost tracking)
      download-zip/route.ts       — Bundle outputs into ZIP
      files/route.ts              — Runtime file server (standalone can't serve runtime files)
      log/route.ts                — Client-side log ingestion
      logs/route.ts               — Log retrieval for debug viewer
  components/
    AdBriefForm.tsx               — Rich brief input form (6 fields)
    FunnelReview.tsx              — Tabbed review UI (TOFU/MOFU/BOFU)
    StyleConfigurator.tsx         — Overlay style presets + custom controls
    VideoSourceTabs.tsx           — Tabbed upload vs AI generate
    VideoUploader.tsx             — Drag-and-drop multi-video upload
    VideoGenerator.tsx            — AI video generation (6 models via kie.ai)
    MusicSelector.tsx             — Upload and configure background music
    VideoPreview.tsx              — Real-time 9:16 preview + trim controls
    TextOverlayEditor.tsx         — Manual overlay editor
    LogViewer.tsx                 — Expandable debug log viewer
    UsageWidget.tsx               — Real-time cost display during operations
    SettingsPanel.tsx             — Company users, invitations, limits
    Tooltip.tsx                   — Reusable info tooltip (hover/tap, CSS-only)
    InfoBanner.tsx                — Info/tip/warning banners with icons
    NotificationBell.tsx          — In-app notification bell with badge + dropdown (30s polling)
    GoogleDriveButton.tsx         — Export-to-Google-Drive button (render results)
    OnboardingChecklist.tsx       — 5-step onboarding checklist (accounts <7 days)
    TemplatePickerModal.tsx       — Template picker modal (system + company)
    SaveAsTemplateModal.tsx       — Save brief as reusable template
  lib/
    types.ts                      — TypeScript interfaces, presets, funnel types
    ffmpeg-renderer.ts            — Core FFmpeg rendering (overlay, audio, trim, quality)
    overlay-renderer.ts           — Canvas-based PNG generation with emoji
    get-video-info.ts             — ffprobe metadata extraction + FFmpeg check
    storage.ts                    — Cloud storage abstraction (local FS / S3 / R2)
    logger.ts                     — Winston logger setup
    prisma.ts                     — Prisma client singleton
    auth.ts                       — NextAuth session helpers, user context
    token-pricing.ts               — Token costs per operation, calculation helpers
    token-balance.ts               — Atomic token deduct/credit/refund/balance/history
    pricing.ts                    — Internal API cost calculation (admin-only)
    track-usage.ts                — Per-call API usage logging (internal costs)
    plans.ts                      — Plan tiers with token allocations + top-up pricing
    check-limits.ts               — Token balance + user limit enforcement
    spend-alerts.ts               — Token-based budget alerts (50%/80%/100%) + email
    stripe.ts                     — Stripe client singleton (lazy-loaded)
    email.ts                      — Resend transactional emails (11 templates)
    api-auth.ts                   — Auth middleware helpers for API routes
    admin-auth.ts                 — Super admin auth helper (SUPER_ADMIN_EMAILS check)
    sanitize.ts                   — HTML stripping for ticket/message input sanitization
    file-url.ts                   — Helper to convert paths to /api/files URLs
    redis.ts                      — ioredis singleton (lazy, graceful fallback)
    rate-limit.ts                 — Redis sorted-set sliding window rate limiter
    cache.ts                      — Redis-backed TTL cache (company info, unread counts)
    queue.ts                      — BullMQ queue setup (renderQueue, videoGenQueue)
    job-types.ts                  — Type-safe job payloads for background jobs
    email-queue.ts                — BullMQ email queue with fallback to direct send
    poll-job.ts                   — Client-side job polling with exponential backoff
  workers/
    index.ts                      — Worker entry point (starts all BullMQ workers)
    render-worker.ts              — Render job processor
    video-gen-worker.ts           — Video gen job processor
    email-worker.ts               — Email job processor (3 retries, exponential backoff)
  middleware.ts                   — JWT verification, rate limiting, security headers
  auth.config.ts                  — NextAuth v5 configuration
prisma/
  schema.prisma                   — Data models: Company, User, Session, ApiUsage, TokenTransaction, TokenTopup, SupportTicket, TicketMessage, AdminAuditLog, Notification, ProjectTemplate
  migrations/                     — Database migrations
```

## When making changes:
1. Preview (VideoPreview.tsx) and renderer (overlay-renderer.ts) share scale constants (PREVIEW_WIDTH=320, FONT_SCALE=0.5, GEOM_SCALE=0.6) — keep them in sync when changing overlay sizing
2. Overlays use canvas PNG rendering (not drawtext) specifically for emoji support
3. Always validate inputs at system boundaries: file sizes before upload, codec support before render, API keys before AI calls
4. Handle partial failures — never throw away successful work because one item failed
5. Show real progress during long operations (X of Y, not just a spinner)
6. Keep the UI dark-themed (gray-950 bg, gray-800 cards, blue-500 accents, green-600 actions)
7. No branding in generated ad copy — the ads are for the client's product only

## Watchdog QA Agent
- `npm run watchdog` — standalone script that continuously tests all endpoints, stress-tests, and auto-remediates
- Config: `scripts/watchdog.config.json` (all overridable via `WATCHDOG_*` env vars)
- Requires `WATCHDOG_EMAIL` / `WATCHDOG_PASSWORD` env vars for authenticated API tests
- Paid API tests disabled by default (`enableGenerateAds`, `enableGenerateVideo`)
- Generates its own test fixtures via FFmpeg in `scripts/fixtures/` (gitignored)
- Reports to `watchdog-report.json` (gitignored)

## Security Agent
- `npm run security` — continuous security audit across 12 categories (blast radius, network, browser, disk, deps, credentials, proxy headers, logs, shell injection, input validation, path traversal, git secrets)
- `npm run security:once` — single scan with exit codes (0=clean, 1=high, 2=critical) for CI
- Config: `scripts/security.config.json` (toggle checks, set thresholds, auto-remediate)
- Reports to `security-report.json` (gitignored, last 50 scans)

## Stress Test Agent
- `npm run stress-test` — simulates N concurrent users (default 100) performing realistic flows
- Phases: register users → login → upload videos → create projects → render → poll jobs → report
- Reports per-endpoint metrics (requests, success%, p50/p95/p99 latency, error rate, throughput)
- Config: `scripts/stress-test.config.json` (overridable via `STRESS_*` env vars)
- Env vars: `STRESS_BASE_URL`, `STRESS_USERS`, `STRESS_CONCURRENCY`, `STRESS_GENERATE_ADS`

## Prerequisites
- Node.js 18+
- PostgreSQL 14+ (local or remote)
- FFmpeg installed (`brew install ffmpeg` / `apt install ffmpeg`)
- `DATABASE_URL` in `.env.local` for PostgreSQL connection
- `NEXTAUTH_SECRET` in `.env.local` (32+ char random string)
- `NEXTAUTH_URL` in `.env.local` (base URL for NextAuth callbacks)
- `ANTHROPIC_API_KEY` in `.env.local` for ad copy generation
- `KIE_API_KEY` in `.env.local` for AI video generation via kie.ai (optional)
- `S3_BUCKET`, `S3_ENDPOINT`, `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY` for cloud storage (optional)
- `SUPER_ADMIN_EMAILS` for super admin access (optional, comma-separated)
- `SPEND_ALERT_WEBHOOK_URL` for budget alert webhooks (optional)
- `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_PRICE_STARTER`, `STRIPE_PRICE_PRO` for payments
- `RESEND_API_KEY`, `EMAIL_FROM` for transactional emails (Resend)
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_REDIRECT_URI` for Google Drive export (optional)
