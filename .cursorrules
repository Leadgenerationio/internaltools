You are building "Ad Maker" — a Next.js web app that generates funnel-based ad copy via AI, lets users review/edit it, then batch-renders video ads with timed text overlays and background music using server-side FFmpeg.

## IMPORTANT: Keep Docs In Sync
After any new feature or major change, always update `ARCHITECTURE.md`, `CLAUDE.md`, and `.cursorrules` to reflect the current state. Don't ask — just do it.

## Architecture

- **Framework**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Database**: PostgreSQL + Prisma ORM (multi-tenant companies, users, API usage tracking)
- **Authentication**: NextAuth v5 (credentials provider, JWT sessions, httpOnly cookies)
- **Multi-tenancy**: Companies with users (roles: OWNER/ADMIN/MEMBER), data filtered by company_id
- **Cost tracking**: Per-call API usage logging in cents (`src/lib/track-usage.ts`, `src/lib/pricing.ts`)
- **Video processing**: FFmpeg via shell exec (server-side), @napi-rs/canvas for emoji-supporting overlay PNGs
- **AI ad copy**: Anthropic SDK (Claude Sonnet) for generating TOFU/MOFU/BOFU ad text
- **AI video generation**: Google Veo 3.1 (optional — users can also upload their own videos)
- **File handling**: Uploads in `public/uploads/`, music in `public/music/`, outputs in `public/outputs/`
- **Cloud storage**: Optional S3/R2 support via `src/lib/storage.ts` (activated by `S3_BUCKET` env var)
- **State**: React useState (no external state management)
- **Logging**: Winston with daily-rotate-file, client-side logs forwarded via `/api/log`
- **Deployment**: Railway with Docker, Next.js standalone output

## App Flow (4 Steps)

1. **Brief** — User fills in a rich ad brief (product, audience, selling points, ad examples, tone, context)
2. **Review** — AI generates 10 ads (4 TOFU, 4 MOFU, 2 BOFU), each with 4-5 text boxes. User edits text, approves/rejects/regenerates individually.
3. **Media** — Upload background videos (or generate via Veo), upload music, configure overlay style (presets + custom colours/fonts/timing)
4. **Render** — Each approved ad is rendered against each uploaded video via FFmpeg. Results shown with progress bar and download all.

## Key Concepts

### Text Overlay Rendering
- Overlays are rendered to PNG using @napi-rs/canvas (NOT FFmpeg drawtext) to support emoji
- PNGs are composited onto video using FFmpeg's `overlay` filter with `enable='between(t,start,end)'`
- Overlays stack vertically from top, each appearing at a staggered time (user-configurable)
- Once a box appears, it stays visible until the video ends
- Style is configurable: preset picker (White Box, Dark Box, Gradient, Minimal) + custom colours, font, opacity

### Funnel Ad Generation
- TOFU (Top of Funnel): Awareness — hooks, curiosity gaps, pain points
- MOFU (Middle of Funnel): Consideration — trust, social proof, education
- BOFU (Bottom of Funnel): Conversion — urgency, CTAs, offers
- No branding is added — "Andro Media" refers to Meta's ad system, not a brand

### Batch Processing
- Users upload multiple background videos
- All approved ads are rendered against all uploaded videos
- E.g. 5 approved ads × 2 videos = 10 output videos
- Partial failure handling — if one ad fails, the rest still render

## File Structure
```
src/
  app/
    page.tsx                      — Main 4-step flow controller (requires auth)
    layout.tsx                    — Root layout
    globals.css                   — Tailwind + custom styles
    welcome/
      page.tsx                    — Public landing page (hero, features, pricing)
    login/
      page.tsx                    — NextAuth login page
    register/
      page.tsx                    — Registration page (new company + user)
    usage/
      page.tsx                    — Usage dashboard (monthly spend, per-service)
    settings/
      page.tsx                    — Company settings (users, invitations, limits)
    admin/
      page.tsx                    — Super admin dashboard (all companies, revenue, API calls)
    api/
      auth/[...nextauth]/
        route.ts                  — NextAuth v5 credentials provider
      auth/register/route.ts      — Create new user + company
      company/users/route.ts      — List, add, remove users
      company/invite/route.ts     — Send email invitations
      usage/route.ts              — Get monthly spend + breakdown
      admin/route.ts              — Super admin platform-wide stats + company breakdown
      generate-ads/route.ts       — Claude API for ad copy (+ cost tracking)
      generate-video/route.ts     — Google Veo API (+ cost tracking)
      upload/route.ts             — Video upload (validates size, extracts metadata)
      upload-music/route.ts       — Music upload (validates format + size)
      render/route.ts             — FFmpeg batch render + cloud storage (+ cost tracking)
      download-zip/route.ts       — Bundle outputs into ZIP
      log/route.ts                — Client-side log ingestion
      logs/route.ts               — Log retrieval for debug viewer
  components/
    AdBriefForm.tsx               — Rich brief input form (6 fields)
    FunnelReview.tsx              — Tabbed review UI (TOFU/MOFU/BOFU)
    StyleConfigurator.tsx         — Overlay style presets + custom controls
    VideoSourceTabs.tsx           — Tabbed upload vs AI generate
    VideoUploader.tsx             — Drag-and-drop multi-video upload
    VideoGenerator.tsx            — AI video generation via Veo
    MusicSelector.tsx             — Upload and configure background music
    VideoPreview.tsx              — Real-time 9:16 preview + trim controls
    TextOverlayEditor.tsx         — Manual overlay editor
    LogViewer.tsx                 — Expandable debug log viewer
    UsageWidget.tsx               — Real-time cost display during operations
    SettingsPanel.tsx             — Company users, invitations, limits
  lib/
    types.ts                      — TypeScript interfaces, presets, funnel types
    ffmpeg-renderer.ts            — Core FFmpeg rendering (overlay, audio, trim, quality)
    overlay-renderer.ts           — Canvas-based PNG generation with emoji
    get-video-info.ts             — ffprobe metadata extraction + FFmpeg check
    storage.ts                    — Cloud storage abstraction (local FS / S3 / R2)
    logger.ts                     — Winston logger setup
    prisma.ts                     — Prisma client singleton
    auth.ts                       — NextAuth session helpers, user context
    pricing.ts                    — API cost calculation per model/tokens
    track-usage.ts                — Per-call usage logging, monthly aggregation
    api-auth.ts                   — Auth middleware helpers for API routes
  middleware.ts                   — JWT verification, rate limiting, security headers
  auth.config.ts                  — NextAuth v5 configuration
prisma/
  schema.prisma                   — Data models: Company, User, Session, ApiUsage
  migrations/                     — Database migrations
```

## When making changes:
1. Preview (VideoPreview.tsx) and renderer (overlay-renderer.ts) share scale constants (PREVIEW_WIDTH=320, FONT_SCALE=0.5, GEOM_SCALE=0.6) — keep them in sync when changing overlay sizing
2. Overlays use canvas PNG rendering (not drawtext) specifically for emoji support
3. Always validate inputs at system boundaries: file sizes before upload, codec support before render, API keys before AI calls
4. Handle partial failures — never throw away successful work because one item failed
5. Show real progress during long operations (X of Y, not just a spinner)
6. Keep the UI dark-themed (gray-950 bg, gray-800 cards, blue-500 accents, green-600 actions)
7. No branding in generated ad copy — the ads are for the client's product only

## Watchdog QA Agent
- `npm run watchdog` — standalone script that continuously tests all endpoints, stress-tests, and auto-remediates
- Config: `scripts/watchdog.config.json` (all overridable via `WATCHDOG_*` env vars)
- Paid API tests disabled by default (`enableGenerateAds`, `enableGenerateVideo`)
- Generates its own test fixtures via FFmpeg in `scripts/fixtures/` (gitignored)
- Reports to `watchdog-report.json` (gitignored)

## Security Agent
- `npm run security` — continuous security audit across 12 categories (blast radius, network, browser, disk, deps, credentials, proxy headers, logs, shell injection, input validation, path traversal, git secrets)
- `npm run security:once` — single scan with exit codes (0=clean, 1=high, 2=critical) for CI
- Config: `scripts/security.config.json` (toggle checks, set thresholds, auto-remediate)
- Reports to `security-report.json` (gitignored, last 50 scans)

## Prerequisites
- Node.js 18+
- PostgreSQL 14+ (local or remote)
- FFmpeg installed (`brew install ffmpeg` / `apt install ffmpeg`)
- `DATABASE_URL` in `.env.local` for PostgreSQL connection
- `NEXTAUTH_SECRET` in `.env.local` (32+ char random string)
- `NEXTAUTH_URL` in `.env.local` (base URL for NextAuth callbacks)
- `ANTHROPIC_API_KEY` in `.env.local` for ad copy generation
- `GOOGLE_API_KEY` in `.env.local` for Veo video generation (optional)
- `S3_BUCKET`, `S3_ENDPOINT`, `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY` for cloud storage (optional)
- Email/SMTP credentials for company invitations (optional but recommended)
